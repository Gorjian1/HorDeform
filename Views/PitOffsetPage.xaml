<UserControl x:Class="Osadka.Views.PitOffsetPage"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:local="clr-namespace:Osadka.Views"
             mc:Ignorable="d"
             d:DesignHeight="720" d:DesignWidth="1180">

    <UserControl.Resources>
        <!-- Проекции/стрелки с поддержкой веса -->
        <local:ToScreenConverter x:Key="ToScreen"/>
        <local:VectorEndWeightedConverter x:Key="VectorEndW"/>
        <local:ArrowHeadPointsWeightedConverter x:Key="HeadW"/>

        <!-- Цвета/штрих/видимость -->
        <local:CycleColorFromSettingsConverter x:Key="CycleColorFromSettingsConverter"/>
        <local:CycleHatchMultiConverter x:Key="CycleHatchConverter"/>
        <local:InvertedBoolToVisibilityConverter x:Key="NotBoolToVis"/>
        <local:EnumEqualsConverter x:Key="EnumEquals"/>
        <local:ColorToHexConverter x:Key="ColorToHex"/>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>

        <!-- Базовые стили -->
        <Style x:Key="Card" TargetType="Border">
            <Setter Property="Padding" Value="8"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="BorderBrush" Value="#22000000"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Background" Value="White"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
        </Style>
        <Style TargetType="TextBlock">
            <Setter Property="VerticalAlignment" Value="Center"/>
        </Style>
        <Style TargetType="Button">
            <Setter Property="Margin" Value="0,6,0,0"/>
            <Setter Property="MinWidth" Value="120"/>
        </Style>
        <Style TargetType="ComboBox">
            <Setter Property="Margin" Value="0,2,0,0"/>
            <Setter Property="MinWidth" Value="120"/>
        </Style>
        <Style TargetType="TextBox">
            <Setter Property="Margin" Value="0,2,0,0"/>
            <Setter Property="MinWidth" Value="90"/>
        </Style>
        <Style TargetType="Slider">
            <Setter Property="Margin" Value="0,2,0,0"/>
        </Style>
    </UserControl.Resources>

    <Border Style="{StaticResource Card}">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="220"/>
            </Grid.RowDefinitions>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="360"/>
            </Grid.ColumnDefinitions>

            <!-- ЛЕВАЯ ПЛИТКА -->
            <Border Grid.Row="0" Grid.Column="0" Style="{StaticResource Card}" Margin="0,0,8,8" ClipToBounds="True">
                <Grid x:Name="CanvasHost" Background="Transparent">
                    <!-- Подложка -->
                    <Image Source="{Binding BackgroundImage}"
                           Stretch="Uniform"
                           Opacity="{Binding VectorSettings.BackgroundOpacity}"
                           RenderOptions.BitmapScalingMode="HighQuality"/>

                    <!-- КОНТУРЫ/ЗАЛИВКА (из VM) -->
                    <ItemsControl ItemsSource="{Binding CycleOverlays}" Panel.ZIndex="1" IsHitTestVisible="False">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <Canvas/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Grid>
                                    <Polygon Points="{Binding Points}"
                                             Visibility="{Binding HasFill, Converter={StaticResource BoolToVis}}"
                                             StrokeThickness="2"
                                             Opacity="{Binding DataContext.VectorSettings.FillOpacity, RelativeSource={RelativeSource AncestorType=UserControl}}">
                                        <Polygon.Stroke>
                                            <MultiBinding Converter="{StaticResource CycleColorFromSettingsConverter}">
                                                <Binding Path="CycleId"/>
                                                <Binding Path="DataContext.VectorSettings" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.VectorSettings.Version" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                            </MultiBinding>
                                        </Polygon.Stroke>
                                        <Polygon.Fill>
                                            <MultiBinding Converter="{StaticResource CycleHatchConverter}">
                                                <Binding Path="CycleId"/>
                                                <Binding Path="DataContext.VectorSettings" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.VectorSettings.Version" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                            </MultiBinding>
                                        </Polygon.Fill>
                                    </Polygon>

                                    <!-- Фоллбек: нет площади -->
                                    <Polyline Points="{Binding Points}"
                                              Visibility="{Binding HasFill, Converter={StaticResource NotBoolToVis}}"
                                              StrokeThickness="2">
                                        <Polyline.Stroke>
                                            <MultiBinding Converter="{StaticResource CycleColorFromSettingsConverter}">
                                                <Binding Path="CycleId"/>
                                                <Binding Path="DataContext.VectorSettings" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.VectorSettings.Version" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                            </MultiBinding>
                                        </Polyline.Stroke>
                                    </Polyline>
                                </Grid>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- СТРЕЛКИ -->
                    <ItemsControl ItemsSource="{Binding Rows}" Panel.ZIndex="2">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <Canvas/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Canvas>
                                    <Line StrokeThickness="{Binding DataContext.VectorSettings.LineThickness, RelativeSource={RelativeSource AncestorType=UserControl}}">
                                        <Line.Stroke>
                                            <MultiBinding Converter="{StaticResource CycleColorFromSettingsConverter}">
                                                <Binding Path="CycleId"/>
                                                <Binding Path="DataContext.VectorSettings" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.VectorSettings.Version" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                            </MultiBinding>
                                        </Line.Stroke>

                                        <!-- начало -->
                                        <Line.X1>
                                            <MultiBinding Converter="{StaticResource ToScreen}" ConverterParameter="x">
                                                <Binding Path="X"/>
                                                <Binding Path="Y"/>
                                                <Binding Path="DataContext.Scale" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.OffsetX" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.OffsetY" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.RotationDeg" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                            </MultiBinding>
                                        </Line.X1>
                                        <Line.Y1>
                                            <MultiBinding Converter="{StaticResource ToScreen}" ConverterParameter="y">
                                                <Binding Path="X"/>
                                                <Binding Path="Y"/>
                                                <Binding Path="DataContext.Scale" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.OffsetX" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.OffsetY" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.RotationDeg" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                            </MultiBinding>
                                        </Line.Y1>

                                        <!-- конец с весом -->
                                        <Line.X2>
                                            <MultiBinding Converter="{StaticResource VectorEndW}" ConverterParameter="x">
                                                <Binding Path="."/>
                                                <Binding Path="DataContext.Scale" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.OffsetX" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.OffsetY" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.VectorSettings.VectorScaleBase" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.RotationDeg" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.MaxVVisible" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.VectorSettings" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.VectorSettings.Version" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                            </MultiBinding>
                                        </Line.X2>
                                        <Line.Y2>
                                            <MultiBinding Converter="{StaticResource VectorEndW}" ConverterParameter="y">
                                                <Binding Path="."/>
                                                <Binding Path="DataContext.Scale" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.OffsetX" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.OffsetY" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.VectorSettings.VectorScaleBase" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.RotationDeg" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.MaxVVisible" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.VectorSettings" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.VectorSettings.Version" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                            </MultiBinding>
                                        </Line.Y2>
                                    </Line>

                                    <!-- наконечник -->
                                    <Polygon>
                                        <Polygon.Fill>
                                            <MultiBinding Converter="{StaticResource CycleColorFromSettingsConverter}">
                                                <Binding Path="CycleId"/>
                                                <Binding Path="DataContext.VectorSettings" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.VectorSettings.Version" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                            </MultiBinding>
                                        </Polygon.Fill>
                                        <Polygon.Points>
                                            <MultiBinding Converter="{StaticResource HeadW}">
                                                <Binding Path="."/>
                                                <Binding Path="DataContext.Scale" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.OffsetX" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.OffsetY" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.VectorSettings.VectorScaleBase" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.VectorSettings.ArrowHeadSize" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.RotationDeg" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.MaxVVisible" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.VectorSettings" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.VectorSettings.Version" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                            </MultiBinding>
                                        </Polygon.Points>
                                    </Polygon>

                                    <!-- подпись -->
                                    <TextBlock Text="{Binding N}"
                                               FontSize="{Binding DataContext.VectorSettings.LabelFontSize, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                               Visibility="{Binding DataContext.VectorSettings.ShowLabels, RelativeSource={RelativeSource AncestorType=UserControl}, Converter={StaticResource BoolToVis}}">
                                        <Canvas.Left>
                                            <MultiBinding Converter="{StaticResource ToScreen}" ConverterParameter="x">
                                                <Binding Path="X"/><Binding Path="Y"/>
                                                <Binding Path="DataContext.Scale" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.OffsetX" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.OffsetY" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.RotationDeg" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                            </MultiBinding>
                                        </Canvas.Left>
                                        <Canvas.Top>
                                            <MultiBinding Converter="{StaticResource ToScreen}" ConverterParameter="y">
                                                <Binding Path="X"/><Binding Path="Y"/>
                                                <Binding Path="DataContext.Scale" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.OffsetX" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.OffsetY" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                                <Binding Path="DataContext.RotationDeg" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
                                            </MultiBinding>
                                        </Canvas.Top>
                                    </TextBlock>
                                </Canvas>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- Оверлей построения -->
                    <Grid Visibility="{Binding IsBuildMode, Converter={StaticResource BoolToVis}}">
                        <Canvas x:Name="BuildOverlayCanvas" IsHitTestVisible="False">
                            <ItemsControl ItemsSource="{Binding Anchors}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <Canvas/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Canvas>
                                            <Ellipse Width="8" Height="8" Fill="#FF0066FF" Stroke="White" StrokeThickness="1.5">
                                                <Canvas.Left>
                                                    <Binding Path="ImageU"/>
                                                </Canvas.Left>
                                                <Canvas.Top>
                                                    <Binding Path="ImageV"/>
                                                </Canvas.Top>
                                            </Ellipse>
                                            <Ellipse Width="6" Height="6" Fill="#FFFF0066" Stroke="White" StrokeThickness="1.2"
                                                     Visibility="{Binding PredictedU, Converter={StaticResource BoolToVis}}">
                                                <Canvas.Left>
                                                    <Binding Path="PredictedU"/>
                                                </Canvas.Left>
                                                <Canvas.Top>
                                                    <Binding Path="PredictedV"/>
                                                </Canvas.Top>
                                            </Ellipse>
                                            <Line Stroke="#9900AAFF" StrokeDashArray="4,2" StrokeThickness="1.2"
                                                  Visibility="{Binding PredictedU, Converter={StaticResource BoolToVis}}">
                                                <Line.X1>
                                                    <Binding Path="PredictedU"/>
                                                </Line.X1>
                                                <Line.Y1>
                                                    <Binding Path="PredictedV"/>
                                                </Line.Y1>
                                                <Line.X2>
                                                    <Binding Path="ImageU"/>
                                                </Line.X2>
                                                <Line.Y2>
                                                    <Binding Path="ImageV"/>
                                                </Line.Y2>
                                            </Line>
                                        </Canvas>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                            <Rectangle x:Name="SelectionRect" Visibility="Collapsed"
                                       Stroke="#AA007ACC" StrokeThickness="1.5" StrokeDashArray="4,2"
                                       Fill="#22007ACC"/>
                        </Canvas>
                    </Grid>
                </Grid>
            </Border>

            <!-- ПРАВАЯ ПАНЕЛЬ -->
            <Border Grid.Row="0" Grid.Column="1" Style="{StaticResource Card}" Margin="8,0,0,8">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <TextBlock Text="Окно взаимодействия" FontWeight="Bold" FontSize="16" Margin="0,0,0,8"/>

                        <TextBlock Text="Объект"/>
                        <ComboBox ItemsSource="{Binding Objects}" SelectedItem="{Binding SelectedObject}"/>

                        <TextBlock Text="Циклы (включаемые)"/>
                        <Grid>
                            <ToggleButton x:Name="CyclesDrop"
                                          Content="{Binding SelectedCyclesSummary}"
                                          Padding="6" BorderBrush="#88000000" BorderThickness="1" Background="#FFF"/>
                            <Popup PlacementTarget="{Binding ElementName=CyclesDrop}"
                                   IsOpen="{Binding IsChecked, ElementName=CyclesDrop}"
                                   StaysOpen="False" AllowsTransparency="True">
                                <Border Background="White" BorderBrush="#88000000" BorderThickness="1" Padding="6" CornerRadius="6">
                                    <ScrollViewer Height="220" Width="300">
                                        <ItemsControl ItemsSource="{Binding Cycles}">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <CheckBox IsChecked="{Binding IsSelected, Mode=TwoWay}" Content="{Binding Id}" Margin="0,4,0,0"/>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </ScrollViewer>
                                </Border>
                            </Popup>
                        </Grid>

                        <Separator Margin="8,10"/>

                        <!-- ПАНЕЛЬ ПОСТРОЕНИЯ -->
                        <TextBlock Text="Построение контуров и векторов" FontWeight="Bold"/>
                        <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                            <TextBlock Text="Статус:" VerticalAlignment="Center"/>
                            <TextBlock Text="{Binding BuildRmsInfo}" Margin="6,0,0,0" FontWeight="SemiBold" VerticalAlignment="Center"/>
                        </StackPanel>
                        <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                            <ToggleButton Content="Точка" IsChecked="{Binding IsToolPoint, Mode=TwoWay}" Width="110"/>
                            <ToggleButton Content="Прямоугольник" IsChecked="{Binding IsToolRect, Mode=TwoWay}" Width="140" Margin="6,0,0,0"/>
                            <Button Content="Построить" Command="{Binding BuildCommand}" Margin="12,0,0,0"/>
                        </StackPanel>
                        <StackPanel Orientation="Horizontal">
                            <Button Content="Применить" Command="{Binding AcceptBuildCommand}"/>
                            <Button Content="Очистить" Command="{Binding ClearAnchorsCommand}" Margin="6,0,0,0"/>
                            <Button Content="Отмена" Command="{Binding CancelBuildCommand}" Margin="6,0,0,0"/>
                        </StackPanel>

                        <UniformGrid Columns="3" Margin="0,8,0,0">
                            <Button Content="⟲ Повернуть -90°" Command="{Binding RotateLeft90Command}"/>
                            <Button Content="Сброс трансформации" Command="{Binding ResetTransformCommand}"/>
                            <Button Content="Повернуть +90° ⟳" Command="{Binding RotateRight90Command}"/>
                        </UniformGrid>

                        <StackPanel Orientation="Horizontal" Margin="0,6,0,0">
                            <TextBlock Text="Поворот (°)" Width="110"/>
                            <Slider Minimum="-180" Maximum="180" Value="{Binding RotationDeg}" TickFrequency="15" IsSnapToTickEnabled="True" Width="180"/>
                            <TextBox Text="{Binding RotationDeg, StringFormat=F1}" Width="70" Margin="6,0,0,0"/>
                        </StackPanel>

                        <Separator Margin="8,10"/>

                        <TextBlock Text="Настройки отображения" FontWeight="Bold"/>
                        <Button Content="Открыть…" Command="{Binding OpenVectorSettingsCommand}"/>

                        <Separator Margin="8,10"/>

                        <TextBlock Text="Вставка подложки" FontWeight="Bold"/>
                        <Button Content="Загрузить подложку" Command="{Binding LoadBackgroundCommand}"/>
                        <Button Content="Очистить подложку" Command="{Binding ClearBackgroundCommand}"/>

                        <Separator Margin="8,10"/>

                        <TextBlock Text="Экспорт" FontWeight="Bold"/>
                        <Button Content="Экспорт PNG" Command="{Binding ExportPngCommand}"/>
                    </StackPanel>
                </ScrollViewer>
            </Border>

            <!-- НИЖНЯЯ ТАБЛИЦА -->
            <Border Grid.Row="1" Grid.ColumnSpan="2" Style="{StaticResource Card}" Margin="0,8,0,0">
                <DockPanel>
                    <Grid DockPanel.Dock="Top" Margin="0,0,0,6">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="320"/>
                        </Grid.ColumnDefinitions>
                        <StackPanel Orientation="Horizontal">
                            <TextBlock Text="Таблица точек" FontWeight="Bold" FontSize="14" Margin="0,0,12,0"/>
                            <TextBlock Text="(локально, программу не меняет)" Foreground="#88000000"/>
                        </StackPanel>
                        <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right">
                            <TextBlock Text="Цикл:" VerticalAlignment="Center" Margin="0,0,6,0"/>
                            <ComboBox ItemsSource="{Binding CycleFilterOptions}"
                                      SelectedItem="{Binding SelectedCycleFilter}"
                                      DisplayMemberPath="Title" Width="200"/>
                        </StackPanel>
                    </Grid>

                    <DataGrid ItemsSource="{Binding RowsView}"
                              AutoGenerateColumns="False"
                              CanUserAddRows="False"
                              IsReadOnly="True"
                              HeadersVisibility="Column"
                              Height="180"
                              ColumnWidth="*">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="№"  Binding="{Binding N}"                     Width="0.6*"/>
                            <DataGridTextColumn Header="X"  Binding="{Binding X, StringFormat=F3}"    Width="1.2*"/>
                            <DataGridTextColumn Header="Y"  Binding="{Binding Y, StringFormat=F3}"    Width="1.2*"/>
                            <DataGridTextColumn Header="V"  Binding="{Binding V, StringFormat=F3}"    Width="1*"/>
                            <DataGridTextColumn Header="Dx" Binding="{Binding Dx, StringFormat=F3}"   Width="1*"/>
                            <DataGridTextColumn Header="Dy" Binding="{Binding Dy, StringFormat=F3}"   Width="1*"/>
                        </DataGrid.Columns>
                    </DataGrid>
                </DockPanel>
            </Border>
        </Grid>
    </Border>
</UserControl>
